<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Chosen Palette: Slate & Indigo -->
    <!-- Application Structure Plan: The SPA is designed as a multi-tabbed interface to best serve a developer audience. This structure allows users to either follow a linear learning path (Overview -> Quick Start -> etc.) or jump directly to the specific information they need (API Reference). The core interaction is in the 'API Reference' tab, which uses a two-column layout. A master list of API components (properties/methods) is on the left, and clicking an item dynamically displays its full details on the right. This prevents information overload and creates an efficient, explorable reference. This task-oriented design is superior to a simple linear document for technical documentation. -->
    <!-- Visualization & Content Choices: The report is purely textual/code-based, so no charts are needed. The key is presenting hierarchical information effectively. Goal: Reference -> Viz/Method: Interactive Master-Detail Lists -> Interaction: Click-to-display -> Justification: This is the standard, most effective UX pattern for API documentation, allowing for both quick scanning and in-depth exploration without leaving the page. Goal: Guide -> Viz/Method: Numbered lists with code blocks -> Interaction: Click-to-copy -> Justification: Makes initial steps easy to follow and use. Goal: Demonstrate -> Viz/Method: Full code block display -> Interaction: Click-to-copy -> Justification: Allows developers to easily grab and adapt full working examples. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Apps Developer Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .prose code {
            font-family: 'JetBrains Mono', monospace;
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }
        .prose pre {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            padding: 1.25rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            border: none;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .prose pre:hover .copy-btn {
            opacity: 1;
        }
        .tab {
            transition: all 0.2s ease-in-out;
        }
        .tab.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
        }
        .api-list-item {
            transition: all 0.2s ease-in-out;
        }
        .api-list-item.active, .api-list-item:hover {
            background-color: #eef2ff; /* indigo-50 */
            color: #3730a3; /* indigo-800 */
            transform: translateX(2px);
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8">
            <h1 class="text-4xl font-bold tracking-tight text-slate-900">Trace Apps Developer Documentation</h1>
            <p class="mt-2 text-lg text-slate-600">Your complete guide to building powerful, secure, and integrated applications on the Trace platform.</p>
        </header>

        <main>
            <nav class="flex border-b border-slate-200 mb-8" aria-label="Tabs">
                <button id="tab-btn-overview" class="tab active font-semibold text-slate-600 hover:text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="overview">Overview</button>
                <button id="tab-btn-quickstart" class="tab font-semibold text-slate-600 hover:text-indigo-600 whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm border-transparent" data-tab="quickstart">Quick Start</button>
                <button id="tab-btn-api" class="tab font-semibold text-slate-600 hover:text-indigo-600 whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm border-transparent" data-tab="api">API Reference</button>
                <button id="tab-btn-examples" class="tab font-semibold text-slate-600 hover:text-indigo-600 whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm border-transparent" data-tab="examples">Examples</button>
            </nav>

            <div id="tab-content-overview" class="prose max-w-none">
                <h2 class="text-2xl font-semibold text-slate-800">What are Trace Apps?</h2>
                <p>Trace Apps are lightweight, single-purpose applications that extend the functionality of the Trace Spotlight Search. They are triggered by a forward slash (<code>/</code>) followed by a command (e.g., <code>/notes</code>, <code>/summarize</code>).</p>
                <p>The app system is designed with security and simplicity in mind. Each app runs in a sandboxed environment and interacts with Trace's core functionality through a controlled, secure API. This ensures that third-party apps cannot access sensitive user data or interfere with the extension's primary operations.</p>
            </div>

            <div id="tab-content-quickstart" class="prose max-w-none hidden">
                 <h2 class="text-2xl font-semibold text-slate-800">Creating Your First App</h2>
                 <p>Creating a Trace App involves two main steps: defining the app and registering it with the system.</p>
                 <ol>
                    <li>
                        <strong>Create Your App File</strong>
                        <p>For organization, it's recommended to create a new <code>.js</code> file for your app (e.g., <code>scripts/my-cool-app.js</code>) and include it in the `content_scripts` array in <code>manifest.json</code> <strong>before</strong> the main `content-script.js`.</p>
                        <p>However, for simplicity, you can add your app definition directly to the <code>scripts/apps.js</code> file.</p>
                    </li>
                    <li>
                        <strong>Register Your App</strong>
                        <p>To register your app, you call the <code>window.TraceAppRegistry.register()</code> method, passing it your <code>appDefinition</code> object. This object contains all the metadata and logic for your app.</p>
<pre><button class="copy-btn">Copy</button><code>// In scripts/apps.js or your own app file
window.TraceAppRegistry.register({
    // ... your app definition properties go here
});</code></pre>
                    </li>
                 </ol>
            </div>

            <div id="tab-content-api" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="sticky top-8">
                            <h3 class="text-lg font-semibold text-slate-800 mb-2">API Reference</h3>
                            <p class="text-sm text-slate-500 mb-4">Click an item to see its full details, parameters, and usage examples.</p>
                            
                            <h4 class="font-semibold text-slate-900 mt-6 mb-2 border-b pb-1">App Definition</h4>
                            <ul id="api-list-definition" class="space-y-1"></ul>
                            
                            <h4 class="font-semibold text-slate-900 mt-6 mb-2 border-b pb-1">Trace API</h4>
                            <ul id="api-list-traceapi" class="space-y-1"></ul>
                        </div>
                    </div>
                    <div id="api-detail-panel" class="lg:col-span-2 prose max-w-none bg-white p-6 rounded-lg border border-slate-200 min-h-[60vh]">
                        <p class="text-slate-500">Select an API component from the left to view its documentation.</p>
                    </div>
                 </div>
            </div>

            <div id="tab-content-examples" class="prose max-w-none hidden">
                <h2 class="text-2xl font-semibold text-slate-800">Full Example: A "/todo" App</h2>
                <p>Here is a complete, well-commented example of a simple to-do app. This app will save a new to-do item to a "To-Do List" stash. It demonstrates finding or creating a stash, constructing clip data, and using notifications.</p>
<pre><button class="copy-btn">Copy</button><code>// Register the "/todo" app
window.TraceAppRegistry.register({
    name: "To-Do",
    trigger: "/todo",
    icon: "âœ…",
    description: "Add an item to your To-Do List stash.",
    requiresAuth: true, // This app will only run if the user is signed in.

    handler(inputValue, traceApi) {
        const todoText = inputValue.trim();

        // If the user hasn't typed anything, prompt them.
        if (!todoText) {
            return [{
                resultType: 'app-prompt',
                displayText: "Type your to-do item and press Enter."
            }];
        }

        // Otherwise, show an action to create the to-do.
        return [{
            resultType: 'app-action',
            displayText: `Add To-Do: "${traceApi.escapeHTML(todoText)}"`,
            payload: todoText
        }];
    },

    async onEnter(payload, traceApi) {
        const todoText = payload;
        if (!todoText) return;

        try {
            // 1. Find or create the "To-Do List" stash.
            let todoStash = traceApi.getStashes().find(b => b.name.toLowerCase() === 'to-do list');
            if (!todoStash) {
                traceApi.showNotification("Creating 'To-Do List' stash...", 'info');
                todoStash = await traceApi.createStash('To-Do List');
                // Refresh data so the new stash is available for the next operation.
                await traceApi.refreshData();
            }

            if (!todoStash || !todoStash.id) {
                throw new Error("Could not find or create the 'To-Do List' stash.");
            }

            // 2. Construct the clip data for the new to-do item.
            const clipData = {
                text: todoText,
                html: `[ ] ${traceApi.escapeHTML(todoText)}`, // Add a simple checkbox style
                timestamp: new Date().toISOString(),
                url: `trace://todo/${Date.now()}`, // Internal app-specific URL
                title: `To-Do: ${todoText}`,
                bundleId: todoStash.id,
                author: "Trace To-Do",
                faviconUrl: '',
                ogImage: ''
            };

            // 3. Save the clip and provide feedback.
            await traceApi.createClip(clipData);
            traceApi.showNotification("To-Do item added!", 'success');
            traceApi.hideSpotlight();

        } catch (e) {
            console.error("Trace 'To-Do' App Error:", e);
            traceApi.showNotification(`Error: ${e.message}`, 'error');
            traceApi.hideSpotlight();
        }
    }
});</code></pre>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const apiData = {
                definition: {
                    name: {
                        type: 'string',
                        required: 'Yes',
                        description: 'The user-facing name of the app (e.g., "Note").'
                    },
                    trigger: {
                        type: 'string',
                        required: 'Yes',
                        description: 'The unique command that activates the app, starting with <code>/</code> (e.g., "/notes"). Must be lowercase.'
                    },
                    icon: {
                        type: 'string',
                        required: 'Yes',
                        description: 'An emoji used to represent the app in the UI.'
                    },
                    description: {
                        type: 'string',
                        required: 'Yes',
                        description: 'A brief, one-sentence description of what the app does.'
                    },
                    requiresAuth: {
                        type: 'boolean',
                        required: 'No',
                        description: 'If <code>true</code>, the app can only be activated if the user is signed in. Defaults to <code>false</code>.'
                    },
                    handler: {
                        type: 'function',
                        required: 'Yes',
                        description: 'A function that is called on every input change while the app is active. It returns a list of UI results.',
                        params: '<code>handler(inputValue, traceApi)</code>',
                        returns: 'An <code>Array</code> of result objects (<code>app-prompt</code> or <code>app-action</code>).'
                    },
                    onEnter: {
                        type: 'async function',
                        required: 'Yes',
                        description: 'An <code>async</code> function that is called when a user selects an <code>app-action</code> result. This is the app\'s core logic.',
                        params: '<code>async onEnter(payload, traceApi)</code>',
                        returns: '<code>Promise&lt;void&gt;</code>'
                    }
                },
                traceApi: {
                    getStashes: {
                        description: "Retrieves a deep copy of all the user's stashes (bundles).",
                        returns: "<code>Array&lt;Object&gt;</code> Each object has <code>id</code> and <code>name</code> properties.",
                        usage: "const allStashes = traceApi.getStashes();"
                    },
                    createStash: {
                        params: "<code>createStash(name)</code>",
                        description: "Creates a new stash.",
                        returns: "A <code>Promise</code> that resolves with the newly created stash object.",
                        usage: "const newStash = await traceApi.createStash(\"My New Stash\");"
                    },
                    createClip: {
                        params: "<code>createClip(clipData)</code>",
                        description: "Saves a new clip to the database.",
                        returns: "A <code>Promise</code> that resolves when the clip has been sent to the service worker.",
                        usage: `const clipData = {\n    text: "My clip content",\n    bundleId: "some-bundle-id",\n    // ... other properties\n};\nawait traceApi.createClip(clipData);`
                    },
                    showNotification: {
                        params: "<code>showNotification(message, type)</code>",
                        description: "Displays a temporary notification banner at the top of the screen. The <code>type</code> can be 'success', 'error', or 'info'.",
                        returns: '<code>void</code>',
                        usage: `traceApi.showNotification("It worked!", "success");`
                    },
                    hideSpotlight: {
                        params: "<code>hideSpotlight()</code>",
                        description: "Closes the Spotlight Search UI programmatically.",
                        returns: '<code>void</code>',
                        usage: 'traceApi.hideSpotlight();'
                    },
                    refreshData: {
                        params: "<code>refreshData()</code>",
                        description: "Forces Trace to re-fetch all clips and stashes. Essential to call after creating new data like stashes.",
                        returns: "A <code>Promise</code> that resolves when the data has been refreshed.",
                        usage: 'await traceApi.refreshData();'
                    },
                    escapeHTML: {
                        params: "<code>escapeHTML(string)</code>",
                        description: "A utility function to safely escape a string for insertion into HTML.",
                        returns: "A sanitized <code>string</code>.",
                        usage: "const safeText = traceApi.escapeHTML(\"&lt;script&gt;alert('oops')&lt;/script&gt;\");"
                    }
                }
            };

            const tabButtons = document.querySelectorAll('.tab');
            const tabContents = {
                overview: document.getElementById('tab-content-overview'),
                quickstart: document.getElementById('tab-content-quickstart'),
                api: document.getElementById('tab-content-api'),
                examples: document.getElementById('tab-content-examples'),
            };

            const apiListDefinition = document.getElementById('api-list-definition');
            const apiListTraceApi = document.getElementById('api-list-traceapi');
            const apiDetailPanel = document.getElementById('api-detail-panel');

            function showTab(tabId) {
                Object.values(tabContents).forEach(content => content.classList.add('hidden'));
                tabButtons.forEach(btn => btn.classList.remove('active'));
                
                tabContents[tabId].classList.remove('hidden');
                document.getElementById(`tab-btn-${tabId}`).classList.add('active');
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.dataset.tab);
                });
            });

            function populateApiList(listElement, data, type) {
                Object.keys(data).forEach(key => {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="api-list-item w-full text-left p-2 rounded-md font-medium text-slate-600"><code>${key}</code></button>`;
                    li.querySelector('button').addEventListener('click', () => {
                        showApiDetail(type, key);
                        listElement.querySelectorAll('.api-list-item').forEach(item => item.classList.remove('active'));
                        li.querySelector('button').classList.add('active');
                        document.getElementById('api-list-traceapi').querySelectorAll('.api-list-item').forEach(item => item.classList.remove('active'));

                    });
                    listElement.appendChild(li);
                });
            }
            
             function populateTraceApiList(listElement, data, type) {
                Object.keys(data).forEach(key => {
                    const li = document.createElement('li');
                    li.innerHTML = `<button class="api-list-item w-full text-left p-2 rounded-md font-medium text-slate-600"><code>${key}()</code></button>`;
                    li.querySelector('button').addEventListener('click', () => {
                        showApiDetail(type, key);
                        listElement.querySelectorAll('.api-list-item').forEach(item => item.classList.remove('active'));
                         li.querySelector('button').classList.add('active');
                        document.getElementById('api-list-definition').querySelectorAll('.api-list-item').forEach(item => item.classList.remove('active'));
                    });
                    listElement.appendChild(li);
                });
            }


            function showApiDetail(type, key) {
                const item = apiData[type][key];
                let content = `<h3 class="text-xl font-bold text-slate-900 font-mono flex items-center gap-2">${key} ${type === 'traceApi' ? '()' : ''}</h3>`;
                content += `<p class="mt-2">${item.description}</p>`;

                let details = [];
                if(item.type) details.push({ label: 'Type', value: `<code>${item.type}</code>` });
                if(item.required) details.push({ label: 'Required', value: `<span class="font-semibold ${item.required === 'Yes' ? 'text-green-600' : 'text-amber-600'}">${item.required}</span>` });
                if(item.params) details.push({ label: 'Parameters', value: `<code>${item.params}</code>` });
                if(item.returns) details.push({ label: 'Returns', value: `${item.returns}` });
                
                if (details.length > 0) {
                     content += `<div class="mt-6 border-t pt-4 space-y-3">`;
                     details.forEach(detail => {
                         content += `<div class="grid grid-cols-3 gap-2"><dt class="text-sm font-medium text-slate-500">${detail.label}</dt><dd class="col-span-2 text-sm">${detail.value}</dd></div>`;
                     });
                     content += `</div>`;
                }

                if (item.usage) {
                    content += `<h4 class="font-semibold text-slate-800 mt-6 mb-2">Usage Example</h4>`;
                    content += `<pre><button class="copy-btn">Copy</button><code>${item.usage.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
                }
                apiDetailPanel.innerHTML = content;
                setupCopyButtons();
            }

            function setupCopyButtons() {
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const pre = button.parentElement;
                        const code = pre.querySelector('code');
                        const text = code.innerText;

                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            button.innerText = 'Copied!';
                        } catch (err) {
                            button.innerText = 'Error';
                            console.error('Failed to copy text: ', err);
                        }
                        document.body.removeChild(textArea);
                        setTimeout(() => {
                            button.innerText = 'Copy';
                        }, 2000);
                    });
                });
            }

            populateApiList(apiListDefinition, apiData.definition, 'definition');
            populateTraceApiList(apiListTraceApi, apiData.traceApi, 'traceApi');
            setupCopyButtons();
        });
    </script>

</body>
</html>
