<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Apps Developer Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A0A0A;
            color: #9E9E9E;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #F5F5F5;
        }

        pre, code {
            font-family: 'JetBrains Mono', monospace;
        }

        .prose-invert a {
            color: #60A5FA;
            transition: color 0.2s ease-in-out;
        }

        .prose-invert a:hover {
            color: #93C5FD;
        }
        
        .nav-link.active {
            color: #F5F5F5;
            font-weight: 500;
        }

        .prose-invert code {
            color: #F5F5F5;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }

        .prose-invert pre {
            background-color: #111111;
            border: 1px solid #27272A;
            border-radius: 0.5rem;
            padding: 1.25rem;
            position: relative;
        }

        .prose-invert pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
        }

        .copy-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #1f222c;
            border: 1px solid #374151;
            color: #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-button:hover {
            background-color: #374151;
            color: #fff;
        }
        
        .copy-button.copied {
            background-color: #059669;
            color: #fff;
            border-color: #047857;
        }
        
        .prose-invert table {
            border: 1px solid #27272A;
        }
        .prose-invert th {
            color: #F5F5F5;
            border-bottom: 1px solid #27272A;
        }
        .prose-invert td {
            border-bottom: 1px solid #27272A;
        }

        .prose-invert blockquote {
            border-left-color: #3B82F6;
            color: #D1D5DB;
        }

        /* Syntax Highlighting (Simple) */
        .token.comment { color: #6a9955; }
        .token.keyword { color: #c586c0; }
        .token.string { color: #ce9178; }
        .token.function { color: #dcdcaa; }
        .token.number { color: #b5cea8; }
        .token.boolean { color: #569cd6; }
        .token.operator { color: #d4d4d4; }
        .token.punctuation { color: #d4d4d4; }
        .token.property { color: #9cdcfe; }
        .token.parameter { color: #9cdcfe; }
    </style>
</head>

<body class="antialiased">

    <div class="relative mx-auto max-w-screen-xl">
        <div class="flex flex-col lg:flex-row">

            <!-- Sticky Sidebar Navigation -->
            <aside class="w-full lg:w-64 lg:flex-shrink-0 lg:px-4">
                <div class="lg:sticky lg:top-0 lg:py-8 h-full">
                    <nav id="docs-nav" class="p-4 lg:p-0">
                        <h4 class="mb-4 text-sm font-bold uppercase tracking-wider text-gray-500">On this page</h4>
                        <ul class="space-y-3">
                            <li><a href="#introduction" class="nav-link text-gray-400 transition-colors duration-200 hover:text-white">What are Trace Apps?</a></li>
                            <li><a href="#getting-started" class="nav-link text-gray-400 transition-colors duration-200 hover:text-white">Getting Started</a></li>
                            <li><a href="#app-definition" class="nav-link text-gray-400 transition-colors duration-200 hover:text-white">The appDefinition Object</a></li>
                            <li>
                                <a href="#core-functions" class="nav-link text-gray-400 transition-colors duration-200 hover:text-white">Core Functions</a>
                                <ul class="pl-4 mt-2 space-y-2 border-l border-gray-800">
                                    <li><a href="#handler" class="nav-link text-sm text-gray-500 hover:text-white">handler()</a></li>
                                    <li><a href="#on-enter" class="nav-link text-sm text-gray-500 hover:text-white">onEnter()</a></li>
                                </ul>
                            </li>
                            <li>
                                <a href="#trace-api" class="nav-link text-gray-400 transition-colors duration-200 hover:text-white">The Sandboxed traceApi</a>
                                 <ul class="pl-4 mt-2 space-y-2 border-l border-gray-800">
                                    <li><a href="#api-getStashes" class="nav-link text-sm text-gray-500 hover:text-white">getStashes()</a></li>
                                    <li><a href="#api-createStash" class="nav-link text-sm text-gray-500 hover:text-white">createStash()</a></li>
                                    <li><a href="#api-createClip" class="nav-link text-sm text-gray-500 hover:text-white">createClip()</a></li>
                                    <li><a href="#api-showNotification" class="nav-link text-sm text-gray-500 hover:text-white">showNotification()</a></li>
                                    <li><a href="#api-hideSpotlight" class="nav-link text-sm text-gray-500 hover:text-white">hideSpotlight()</a></li>
                                    <li><a href="#api-refreshData" class="nav-link text-sm text-gray-500 hover:text-white">refreshData()</a></li>
                                    <li><a href="#api-escapeHTML" class="nav-link text-sm text-gray-500 hover:text-white">escapeHTML()</a></li>
                                </ul>
                            </li>
                            <li><a href="#full-example" class="nav-link text-gray-400 transition-colors duration-200 hover:text-white">Full Example: /todo</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="w-full min-w-0 flex-auto px-4 sm:px-6 lg:px-8 py-8">
                <article class="prose prose-invert max-w-none prose-lg">
                    
                    <div class="mb-12">
                        <p class="text-blue-400 font-semibold">API Documentation</p>
                        <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white">Trace Apps</h1>
                        <p class="text-xl mt-4 text-gray-400">Welcome to the Trace Apps developer documentation! This guide will provide you with everything you need to know to build powerful, secure, and integrated applications on the Trace platform.</p>
                    </div>

                    <section id="introduction" class="mb-16 scroll-mt-20">
                        <h2 class="text-3xl font-semibold border-b border-gray-800 pb-2">What are Trace Apps?</h2>
                        <p>Trace Apps are lightweight, single-purpose applications that extend the functionality of the Trace Spotlight Search. They are triggered by a forward slash (<code>/</code>) followed by a command (e.g., <code>/notes</code>, <code>/summarize</code>).</p>
                        <p>The app system is designed with security and simplicity in mind. Each app runs in a sandboxed environment and interacts with Trace's core functionality through a controlled, secure API. This ensures that third-party apps cannot access sensitive user data or interfere with the extension's primary operations.</p>
                    </section>

                    <section id="getting-started" class="mb-16 scroll-mt-20">
                        <h2 class="text-3xl font-semibold border-b border-gray-800 pb-2">Getting Started</h2>
                        <p>Creating a Trace App involves two main steps: defining the app and registering it with the system.</p>
                        
                        <h3 class="text-2xl font-semibold mt-8">Step 1: Create Your App File</h3>
                        <p>For organization, it's recommended to create a new <code>.js</code> file for your app (e.g., <code>scripts/my-cool-app.js</code>) and include it in the <code>content_scripts</code> array in <code>manifest.json</code> <strong>before</strong> the main <code>content-script.js</code>.</p>
                        <blockquote>For simplicity, you can also add your app definition directly to the <code>scripts/apps.js</code> file.</blockquote>

                        <h3 class="text-2xl font-semibold mt-8">Step 2: Register Your App</h3>
                        <p>To register your app, you call the <code>window.TraceAppRegistry.register()</code> method, passing it your <code>appDefinition</code> object.</p>
                        <div class="code-container">
<pre><code class="language-javascript"><span class="token-comment">// In scripts/apps.js or your own app file</span>
<span class="token function">window</span><span class="token punctuation">.</span><span class="token property">TraceAppRegistry</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token-comment">// ... your app definition properties go here</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                        </div>
                    </section>
                    
                    <section id="app-definition" class="mb-16 scroll-mt-20">
                        <h2 class="text-3xl font-semibold border-b border-gray-800 pb-2">The appDefinition Object</h2>
                        <p>The <code>appDefinition</code> is a JavaScript object that tells Trace everything it needs to know about your app. Here is a breakdown of its properties:</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr>
                                        <th class="p-3">Property</th>
                                        <th class="p-3">Type</th>
                                        <th class="p-3">Required</th>
                                        <th class="p-3">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t border-gray-800">
                                        <td class="p-3"><code>name</code></td>
                                        <td class="p-3"><code>string</code></td>
                                        <td class="p-3"><span class="text-green-400">Yes</span></td>
                                        <td class="p-3">The user-facing name of the app (e.g., "Note").</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3"><code>trigger</code></td>
                                        <td class="p-3"><code>string</code></td>
                                        <td class="p-3"><span class="text-green-400">Yes</span></td>
                                        <td class="p-3">The unique command that activates the app, starting with / (e.g., "/notes"). Must be lowercase.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3"><code>icon</code></td>
                                        <td class="p-3"><code>string</code></td>
                                        <td class="p-3"><span class="text-green-400">Yes</span></td>
                                        <td class="p-3">An emoji or SVG string used to represent the app in the UI.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3"><code>description</code></td>
                                        <td class="p-3"><code>string</code></td>
                                        <td class="p-3"><span class="text-green-400">Yes</span></td>
                                        <td class="p-3">A brief, one-sentence description of what the app does.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3"><code>requiresAuth</code></td>
                                        <td class="p-3"><code>boolean</code></td>
                                        <td class="p-3"><span class="text-yellow-400">No</span></td>
                                        <td class="p-3">If true, the app can only be activated if the user is signed in. Defaults to false.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3"><code>handler</code></td>
                                        <td class="p-3"><code>function</code></td>
                                        <td class="p-3"><span class="text-green-400">Yes</span></td>
                                        <td class="p-3">A function called on every input change while the app is active. It returns a list of UI results.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3"><code>onEnter</code></td>
                                        <td class="p-3"><code>function</code></td>
                                        <td class="p-3"><span class="text-green-400">Yes</span></td>
                                        <td class="p-3">An async function called when a user selects an app-action result. This is the app's core logic.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    
                    <section id="core-functions" class="mb-16 scroll-mt-20">
                        <h2 class="text-3xl font-semibold border-b border-gray-800 pb-2">Core Functions in Detail</h2>
                        
                        <div id="handler" class="scroll-mt-20">
                            <h3 class="text-2xl font-semibold mt-8">handler(inputValue, traceApi)</h3>
                            <p>This function is the dynamic part of your app. It's responsible for what the user sees in the results list as they type.</p>
                            <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>inputValue</code> (string): The text the user has typed after the app trigger.</li>
                                <li><code>traceApi</code> (object): The sandboxed API for interacting with Trace.</li>
                            </ul>
                            <p><strong>Returns:</strong> An Array of result objects. Each object can have one of two <code>resultTypes</code>:</p>
                            <p><strong>1. app-prompt:</strong> A non-interactive message to guide the user.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token-property">resultType</span><span class="token operator">:</span> <span class="token-string">'app-prompt'</span><span class="token punctuation">,</span>
    <span class="token-property">displayText</span><span class="token operator">:</span> <span class="token-string">"Type a task and press Enter."</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
                            </div>
                            <p><strong>2. app-action:</strong> An interactive item. When the user selects this, the <code>onEnter</code> function is called.</p>
                             <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token-property">resultType</span><span class="token operator">:</span> <span class="token-string">'app-action'</span><span class="token punctuation">,</span>
    <span class="token-property">displayText</span><span class="token operator">:</span> <span class="token-string">`Add new to-do: "<span class="token-interpolation"><span class="token-interpolation-punctuation punctuation">${</span>inputValue<span class="token-interpolation-punctuation punctuation">}</span></span>"`</span><span class="token punctuation">,</span>
    <span class="token-property">payload</span><span class="token operator">:</span> inputValue <span class="token-comment">// This data is passed to onEnter</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>

                        <div id="on-enter" class="scroll-mt-20">
                            <h3 class="text-2xl font-semibold mt-12">async onEnter(payload, traceApi)</h3>
                            <p>This function executes the main logic of your app. It runs when a user presses Enter on a result of type <code>app-action</code>.</p>
                             <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>payload</code> (any): The <code>payload</code> value you defined in the <code>app-action</code> object returned by your handler.</li>
                                <li><code>traceApi</code> (object): The sandboxed API for interacting with Trace.</li>
                            </ul>
                        </div>
                    </section>

                    <section id="trace-api" class="mb-16 scroll-mt-20">
                        <h2 class="text-3xl font-semibold border-b border-gray-800 pb-2">The Sandboxed traceApi</h2>
                        <p>To ensure security and stability, your app does not have direct access to Trace's internal state. Instead, it is given a <code>traceApi</code> object with a set of safe, approved functions.</p>

                        <div id="api-getStashes" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.getStashes()</h4>
                            <p>Returns a deep copy (<code>Array&lt;Object&gt;</code>) of all the user's stashes. Each object has <code>id</code> and <code>name</code> properties.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">const</span> allStashes <span class="token operator">=</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">getStashes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                         <div id="api-createStash" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.createStash(name)</h4>
                            <p>Returns a <code>Promise</code> that resolves with the newly created stash object.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">const</span> newStash <span class="token operator">=</span> <span class="token-keyword">await</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">createStash</span><span class="token punctuation">(</span><span class="token-string">"My New Stash"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                         <div id="api-createClip" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.createClip(clipData)</h4>
                            <p>Saves a clip. Returns a <code>Promise</code> that resolves when the clip has been sent to the service worker.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">const</span> clipData <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token-property">text</span><span class="token operator">:</span> <span class="token-string">"My clip content"</span><span class="token punctuation">,</span>
    <span class="token-property">html</span><span class="token operator">:</span> <span class="token-string">"My &lt;b&gt;clip&lt;/b&gt; content"</span><span class="token punctuation">,</span>
    <span class="token-property">timestamp</span><span class="token operator">:</span> <span class="token-keyword">new</span> <span class="token-function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token-property">url</span><span class="token operator">:</span> <span class="token-string">"https://example.com"</span><span class="token punctuation">,</span>
    <span class="token-property">title</span><span class="token operator">:</span> <span class="token-string">"Example"</span><span class="token punctuation">,</span>
    <span class="token-property">bundleId</span><span class="token operator">:</span> <span class="token-string">"some-bundle-id"</span><span class="token punctuation">,</span>
    <span class="token-property">author</span><span class="token operator">:</span> <span class="token-string">"Trace"</span><span class="token punctuation">,</span>
    <span class="token-property">faviconUrl</span><span class="token operator">:</span> <span class="token-string">""</span><span class="token punctuation">,</span>
    <span class="token-property">ogImage</span><span class="token operator">:</span> <span class="token-string">""</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token-keyword">await</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">createClip</span><span class="token punctuation">(</span>clipData<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                        <div id="api-showNotification" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.showNotification(message, type)</h4>
                            <p>Displays a notification. Type can be <code>'success'</code>, <code>'error'</code>, or <code>'info'</code>.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token-string">"It worked!"</span><span class="token punctuation">,</span> <span class="token-string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                        <div id="api-hideSpotlight" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.hideSpotlight()</h4>
                            <p>Closes the Spotlight Search UI.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">hideSpotlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                        <div id="api-refreshData" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.refreshData()</h4>
                            <p>Forces Trace to re-fetch all clips and stashes from the database. Returns a <code>Promise</code>.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">await</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">refreshData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                         <div id="api-escapeHTML" class="mt-8 scroll-mt-20">
                            <h4 class="text-xl font-medium">traceApi.escapeHTML(string)</h4>
                            <p>A utility function to safely escape a string for insertion into HTML.</p>
                            <div class="code-container">
<pre><code class="language-javascript"><span class="token-keyword">const</span> safeText <span class="token operator">=</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">escapeHTML</span><span class="token punctuation">(</span><span class="token-string">"&lt;script&gt;alert('oops')&lt;/script&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                            </div>
                        </div>
                    </section>

                     <section id="full-example" class="mb-16 scroll-mt-20">
                        <h2 class="text-3xl font-semibold border-b border-gray-800 pb-2">Full Example: A "/todo" App</h2>
                        <p>Here is a complete, well-commented example of a simple to-do app. This app will save a new to-do item to a "To-Do List" stash.</p>
                         <div class="code-container">
<pre><code class="language-javascript"><span class="token-comment">// Register the "/todo" app</span>
<span class="token function">window</span><span class="token punctuation">.</span><span class="token property">TraceAppRegistry</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token-property">name</span><span class="token operator">:</span> <span class="token-string">"To-Do"</span><span class="token punctuation">,</span>
    <span class="token-property">trigger</span><span class="token operator">:</span> <span class="token-string">"/todo"</span><span class="token punctuation">,</span>
    <span class="token-property">icon</span><span class="token operator">:</span> <span class="token-string">"âœ…"</span><span class="token punctuation">,</span>
    <span class="token-property">description</span><span class="token operator">:</span> <span class="token-string">"Add an item to your To-Do List stash."</span><span class="token punctuation">,</span>
    <span class="token-property">requiresAuth</span><span class="token operator">:</span> <span class="token-boolean">true</span><span class="token punctuation">,</span> <span class="token-comment">// This app will only run if the user is signed in.</span>

    <span class="token function">handler</span><span class="token punctuation">(</span><span class="token-parameter">inputValue</span><span class="token punctuation">,</span> <span class="token-parameter">traceApi</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token-keyword">const</span> todoText <span class="token operator">=</span> inputValue<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token-comment">// If the user hasn't typed anything, prompt them.</span>
        <span class="token-keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>todoText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token-keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                <span class="token-property">resultType</span><span class="token operator">:</span> <span class="token-string">'app-prompt'</span><span class="token punctuation">,</span>
                <span class="token-property">displayText</span><span class="token operator">:</span> <span class="token-string">"Type your to-do item and press Enter."</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token-comment">// Otherwise, show an action to create the to-do.</span>
        <span class="token-keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token-property">resultType</span><span class="token operator">:</span> <span class="token-string">'app-action'</span><span class="token punctuation">,</span>
            <span class="token-property">displayText</span><span class="token operator">:</span> <span class="token-string">`Add To-Do: "<span class="token-interpolation"><span class="token-interpolation-punctuation punctuation">${</span><span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">escapeHTML</span><span class="token punctuation">(</span>todoText<span class="token punctuation">)</span><span class="token-interpolation-punctuation punctuation">}</span></span>"`</span><span class="token punctuation">,</span>
            <span class="token-property">payload</span><span class="token operator">:</span> todoText
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token-keyword">async</span> <span class="token function">onEnter</span><span class="token punctuation">(</span><span class="token-parameter">payload</span><span class="token punctuation">,</span> <span class="token-parameter">traceApi</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token-keyword">const</span> todoText <span class="token operator">=</span> payload<span class="token punctuation">;</span>
        <span class="token-keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>todoText<span class="token punctuation">)</span> <span class="token-keyword">return</span><span class="token punctuation">;</span>

        <span class="token-keyword">try</span> <span class="token punctuation">{</span>
            <span class="token-comment">// 1. Find or create the "To-Do List" stash.</span>
            <span class="token-keyword">let</span> todoStash <span class="token operator">=</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">getStashes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token-parameter">b</span> <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token-string">'to-do list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token-keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>todoStash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token-string">"Creating 'To-Do List' stash..."</span><span class="token punctuation">,</span> <span class="token-string">'info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                todoStash <span class="token operator">=</span> <span class="token-keyword">await</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">createStash</span><span class="token punctuation">(</span><span class="token-string">'To-Do List'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token-keyword">await</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">refreshData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token-keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>todoStash <span class="token operator">||</span> <span class="token operator">!</span>todoStash<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token-keyword">throw</span> <span class="token-keyword">new</span> <span class="token-function">Error</span><span class="token punctuation">(</span><span class="token-string">"Could not find or create the 'To-Do List' stash."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token-comment">// 2. Construct the clip data for the new to-do item.</span>
            <span class="token-keyword">const</span> clipData <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token-property">text</span><span class="token operator">:</span> todoText<span class="token punctuation">,</span>
                <span class="token-property">html</span><span class="token operator">:</span> <span class="token-string">`[ ] <span class="token-interpolation"><span class="token-interpolation-punctuation punctuation">${</span><span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">escapeHTML</span><span class="token punctuation">(</span>todoText<span class="token punctuation">)</span><span class="token-interpolation-punctuation punctuation">}</span></span>`</span><span class="token punctuation">,</span>
                <span class="token-property">timestamp</span><span class="token operator">:</span> <span class="token-keyword">new</span> <span class="token-function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token-property">url</span><span class="token operator">:</span> <span class="token-string">`trace://todo/<span class="token-interpolation"><span class="token-interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token-interpolation-punctuation punctuation">}</span></span>`</span><span class="token punctuation">,</span>
                <span class="token-property">title</span><span class="token operator">:</span> <span class="token-string">`To-Do: <span class="token-interpolation"><span class="token-interpolation-punctuation punctuation">${</span>todoText<span class="token-interpolation-punctuation punctuation">}</span></span>`</span><span class="token punctuation">,</span>
                <span class="token-property">bundleId</span><span class="token operator">:</span> todoStash<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                <span class="token-property">author</span><span class="token operator">:</span> <span class="token-string">"Trace To-Do"</span><span class="token punctuation">,</span>
                <span class="token-property">faviconUrl</span><span class="token operator">:</span> <span class="token-string">''</span><span class="token punctuation">,</span>
                <span class="token-property">ogImage</span><span class="token operator">:</span> <span class="token-string">''</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token-comment">// 3. Save the clip and provide feedback.</span>
            <span class="token-keyword">await</span> <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">createClip</span><span class="token punctuation">(</span>clipData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token-string">"To-Do item added!"</span><span class="token punctuation">,</span> <span class="token-string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">hideSpotlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token-keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token-string">"Trace 'To-Do' App Error:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token-string">`Error: <span class="token-interpolation"><span class="token-interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>message<span class="token-interpolation-punctuation punctuation">}</span></span>`</span><span class="token punctuation">,</span> <span class="token-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token-property">traceApi</span><span class="token punctuation">.</span><span class="token function">hideSpotlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                        </div>
                    </section>
                </article>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Copy Button Functionality ---
            const allCodeContainers = document.querySelectorAll('.code-container, .prose-invert pre');
            allCodeContainers.forEach(container => {
                // For containers that are <pre>, the code is inside. For <div>, it's the <pre> child.
                const pre = container.tagName === 'PRE' ? container : container.querySelector('pre');
                if (!pre) return;

                const code = pre.querySelector('code');
                if (!code) return;

                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = 'Copy';
                pre.appendChild(button);

                button.addEventListener('click', () => {
                    const textToCopy = code.innerText;
                    
                    // A temporary textarea is used to preserve formatting
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                           button.textContent = 'Copy';
                           button.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        button.textContent = 'Error';
                    }
                    document.body.removeChild(textArea);
                });
            });

            // --- Active Nav Link Highlighting on Scroll ---
            const sectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const navLink = document.querySelector(`.nav-link[href="#${id}"]`);
                    
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.nav-link.active').forEach(link => link.classList.remove('active'));
                        if(navLink) navLink.classList.add('active');
                    }
                });
            }, { rootMargin: "-30% 0px -70% 0px" }); // Highlights when section is in the middle 30% of the viewport

            document.querySelectorAll('section[id]').forEach((section) => {
                sectionObserver.observe(section);
            });
        });
    </script>
</body>
</html>
